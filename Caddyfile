{
	admin off

	servers {
		trusted_proxies cloudflare
		trusted_proxies_strict
		client_ip_headers X-Forwarded-For X-Real-IP
	}
}

www.{$DOMAIN:forsen.wiki} {
	redir {$DOMAIN:forsen.wiki}{uri}
}

{$FULL_DOMAIN:forsen.wiki} {
	handle_path /usercontent* {
		handle {
			root * /srv
			file_server
		}
	}

	handle {
		reverse_proxy sveltekit
	}

	log {
		output file {$CADDY_ACCESS_LOG:/var/log/access-forsen-wiki.log} {
			roll_keep_for 1d
			roll_size 10MiB
		}
		format transform `{request>client_ip} - {request>user_id} [{ts}] "{request>method} {request>uri} {request>proto}" {status} {size} "{request>headers>Referer>[0]}" "{request>headers>User-Agent>[0]}" "{response>headers>Title>[0]}"` {
			time_format "02/Jan/2006:15:04:05 +0200"
		}
	}

	log {
		output file {$CADDY_ACCESS_LOG_JSON:/var/log/access-forsen-wiki.caddylog} {
			roll_keep_for 1d
			roll_size 10MiB
		}
		format json
	}
}

{$GOATCOUNTER_PREFIX:stats}.{$DOMAIN:forsen.wiki} {
	reverse_proxy goatcounter:8080
}
